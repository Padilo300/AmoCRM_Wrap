# Обёртка для простого взаимодействия с Api AmoCRM

## Подключение

В самом начале файла в котором вы планируете использовать обёртку. Возможно убрать лишние не используемые классы.
```php
<?php
use AmoCRM\Amo;
use AmoCRM\Contact;
use AmoCRM\Lead;
```
Далее, в любом месте перед использованием обёртки, нужно подключить файл автозагрузки классов 'autoload.php'. Путь к файлу конечно же может отличаться от примера ниже.
```php
<?php require_once 'AmoCRM_Wrap/autoload.php'; ?>
```
## Использование
Для начала нужно произвести авторизацию. Для этого вызываем статический метод 'authorization' у класса 'Амо' в который необходимо передать:

1. Субдомен црм
2. Логин юзера(почта)
3. Хэш этого юзера

```php
<?php
Amo::authorization('test', 'test@test.ru', '011c2d7f862c688286b43ef552fb17f4');
if (Amo::isAuthorization()) {
    echo 'Всё норм';
} else {
    die('что-то пошло не так');
}
?>
```

## Возможности
* Статичный метод для очистки телефона от лишних символов. Применяется при поиске по контактам.
* Поиск контакта по телефону или почте. Возвращается массив из "Контактов" которые имеют или данный телефон или почту). Даный метод можно использовать для поиска дублей.
* Создание и/или изменение контактов и сделок
* Прикрепление к ним текстовых заметок
* Удобная работа с доп полями, без знания их id и т.п.
* На все запросы возвращается не огромный масив с данными а удобные для работы объекты (Контакт или Сделка)

## В ближайших плана
* Создание/изменение Задач
* Добавление в кастомные поля обработку из множества значений
* Возвращать значение определённого кастомного поля или всех в виде ассоциативного массива

# Описание методов основных классов

## Класс Amo
* **Amo::clearPhone($phone)** — Статичный метод отчистки телефона от лишних символов. Возвращяет (int)
* **Amo::authorization** — Возвращает true в случаее успешной авторизации и false в случае провала
* **Amo::isAuthorization()** — Проверяет текущую авторизацию и возхвращает true в случаее успешной авторизации и false в случае провала
* **Amo::searchContact($phone, $email)** — Производит поиск по контактам. При этом не учитывает формат телефона (телефоны начинающиеся с 7 или 8 считает разными). Возвращяет нумерованый массив из объектов класса Contact

## Абстрактный класс Base
На этом классе базируются все другие основные классы. Все методы присутствующие в нём можно использовать в других классах.
* **__construct($id = null)** — Метод вызываемый при создании экземпляра класса. Можно передать id нужной сущности и тогда произойд\т загрузка данный из црм. Если не передавать id то будет создан новый объект. Если заполнить и сохранить его, он появится в црм.
* **save()** — Сохраняет текущий объект в црм. Возвращает true в случае успеха и false в случае ошибки.
* **getId()** — Возвращает id сущьности
* **getName()** — Возвращает наименование сущьности
* **setName($name)** — Изменяет имя на $name
* **getResponsibleUserId()** — Возвращает id ответственного за сущьность
* **setResponsibleUserId($responsibleUser)** — Устанавливает ответственного за сущьность. Принимает либо id ответственного либо его имя (ищет эту строку во всех именах всех менеджеров црм). Возвращает true если такой менеджер есть или false если такого нет
* **getLinkedCompanyId()** — Возвращает id компании к которой привязан контакт
* **setLinkedCompanyId($linkedCompanyId)** — Устанавливает id компании к которой будет привязан контакт
* **getTags()** — Возвращает ассоциативный массив тэгов id => name
* **addTag($tag)** — Добавляет тэг к имеющимся
* **delTag($tag)** — Ищет и удаляет тэг из имеющихся. Возвращает true или false если $tag не найден
* **setCustomField($customFieldNameOrId, $value = null)** — Задаёт значение кастомного поля. Первым аргументов можно передать как id поля, так и его название в црм. Если не передавать значение ($value) или задать его пустым, то при сохранении поле в црм так же будет отчишено.
* **addNote($text)** — Добавляет текстовую заметку для текущей сущности

## Класс Contact

* **getPhones()** — Нумерованый массив телефонов
* **addPhone($phone, $enum = 'OTHER')** — Добавляет телефон $phone к текущим, не обязательны пораметр тип телефона, по умолчанию "Другой". Возвращяет true или false в случае если тип телефона не корректный. Проверяет имеется ли уже такой телефон у контакт и не добавляет дубликат
Возможные варианты:
WORK - Рабочий
WORKDD - Прямой
MOB - Мобильный
FAX - Факс
HOME - Домашний
OTHER - Другой
* **delPhone($phone)** — Ищет и удаляет телфон из имеющихся. Не учитывает формат телефона. Учитывает начинается телефон с 7 или 8. Возвращает true или false если $phone не найден
* **getEmails()** — Нумерованый массив email'ов
* **addEmails($email, $enum = 'OTHER')** — Добавляет почту $email к текущим, не обязательны пораметр тип почты, по умолчанию "Другой". Возвращяет true или false в случае если тип почты не корректный. Проверяет имеется ли уже такая почта у контакт и не добавляет дубликат
Возможные варианты:
WORK - Рабочая
PRIV - Личная
OTHER - Другая
* **delEmail($email)** — Ищет и удаляет почту из имеющихся. Возвращает true или false если $email не найден
* **getLinkedLeadsId()** — Нумерованый массив id сделок привязанных к контакту
* **addLinkedLeadId($linkedLeadId)** — Добавляет id сделки к имеющимся привязанным к контакту
* **delLinkedLeadId($linkedLeadId)** — Ищет и удаляет id сделки из имеющихся. Возвращает true или false если $linkedLeadId не найден

## Класс Lead

* **getPrice()** — Возвращает бюджет
* **setPrice($price)** — Задаёт бюджет
* **getStatusId()** — Возвращает id статуса
* **getStatusName()** — Возвращает название статуса
* **setStatus($idOrName)** — Задаёт статус. Принимает id статуса либо его название из црм
* **getPipelineId()** — Возвращает id воронки
* **getPipelineName()** — Возвращает название воронки
* **setPipeline($idOrNamePipeline, $idOrNameStatus)** — Переносит сделку в воронку $idOrNamePipeline со статусом $idOrNameStatus. . Принимает как id, так и название из црм и воронки и статуса
* **getMainContactId()** — Возвращает id основного контакта
* **setMainContactId($mainContactId)** — Задаёт id основного контакта


## Классы хэлперы Info, CustomField и Value
Созданы как вспомогательные классы. В дальнейшем скорей всего будет исключенно прямое взаимодействие с ними, по этому описывать их не буду)

# Примеры

## Поиск, изменение и сохранение контакта в црм
```php
<?php
$contacts = Amo::searchContact('79998887766', 'test@test.ru'); //Ищем контакт по телефону и почте
$contact = current($contacts); //берём первый найденый контакт
$contact->setName($contact->getName() . ' лучший'); //Меняем имя дописывая в текущее строчку
$contact->addPhone('78889998887766', 'MOB'); //Добавляем мобильный телефон
$contact->addEmail('test2@test.ru', 'WORK'); //Добавляем рабочую почту
$contact->delEmail('test@test.ru'); //Удаляем почту
$contact->setResponsibleUserId('Пётр Иванович'); //Меняем ответственного
$contact->save(); //Сохраняем все изменение на сервере црм
?>
```